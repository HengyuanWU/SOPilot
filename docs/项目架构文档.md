# FastAPI 项目架构文档

## 项目概述

这是一个基于 FastAPI 的大型 Web 应用程序架构模板，采用分层架构和模块化设计，支持多数据库、异步处理、任务队列等企业级功能。

## 整体架构设计

### 架构分层

```
project_root/
├── 应用层 (application/)         # 应用配置和启动
├── 业务模块层 (apps/)           # 具体业务功能模块
├── 核心层 (core/)              # 核心基础功能
├── 数据层 (db/)               # 数据库抽象层  
├── 工具层 (utils/)            # 公共工具函数
├── 脚本层 (scripts/)          # 自动化脚本工具
├── 数据迁移层 (alembic/)       # 数据库迁移管理
├── 静态资源层 (static/)        # 静态文件存储
├── 文档层 (docs/)             # 项目文档
├── 日志层 (logs/)             # 日志文件存储
├── 临时文件层 (temp/)          # 临时文件存储
└── 主程序入口 (main.py)        # 应用启动入口
```

## 目录结构详解

### 1. 应用配置层 (`application/`)

**功能**: 应用级别的配置和路由管理

```
application/
├── __init__.py                 # 包初始化
├── settings.py                 # 主配置文件，统一配置管理
├── urls.py                     # 全局路由配置，统一注册所有应用路由
└── config/                     # 环境配置目录
    ├── __init__.py
    ├── development.py          # 开发环境配置
    └── production.py           # 生产环境配置
```

**设计原则**:
- 配置分离：开发和生产环境配置分离
- 统一入口：所有应用路由在 `urls.py` 中统一注册
- 环境变量驱动：通过环境变量 `TF_APP_ENV` 切换配置

### 2. 业务模块层 (`apps/`)

**功能**: 各个独立的业务功能模块

```
apps/
├── {app_name}/                 # 单个应用模块
│   ├── __init__.py
│   ├── views.py               # 视图层，定义API接口
│   ├── models/                # 模型层目录
│   │   ├── __init__.py
│   │   └── {model_name}.py    # 数据库模型定义
│   ├── schemas/               # 数据验证层目录
│   │   ├── __init__.py
│   │   └── {schema_name}.py   # Pydantic 数据验证模型
│   ├── crud.py                # 数据访问层，数据库CRUD操作
│   ├── params/                # 请求参数层目录
│   │   ├── __init__.py
│   │   └── params.py          # 查询参数定义
│   ├── utils/                 # 应用内工具函数
│   ├── processors/            # 业务处理器目录（可选）
│   └── docs/                  # 应用文档（可选）
```

**模块标准结构**:
- `models/`: SQLAlchemy ORM 模型定义
- `schemas/`: Pydantic 数据验证和序列化模型
- `views.py`: FastAPI 路由和接口定义
- `crud.py`: 数据库访问层，封装CRUD操作
- `params/`: 查询参数和过滤器定义
- `utils/`: 模块内部工具函数
- `processors/`: 复杂业务逻辑处理器

### 3. 核心基础层 (`core/`)

**功能**: 框架核心功能组件

```
core/
├── __init__.py
├── database.py                # 数据库连接和会话管理
├── crud.py                    # 基础CRUD操作类
├── dependencies.py            # 依赖注入组件
├── exception.py               # 全局异常处理
├── middleware.py              # 中间件定义
├── logger.py                  # 日志配置
├── validator.py               # 自定义验证器
├── docs.py                    # API文档配置
├── event.py                   # 应用生命周期事件
├── enum.py                    # 枚举类型定义
├── data_types.py              # 自定义数据类型
└── mongo_manage.py            # MongoDB 管理器
```

**核心组件说明**:
- `database.py`: 支持多数据库（PostgreSQL、MySQL、MongoDB、Redis）
- `crud.py`: 提供基础CRUD操作基类
- `middleware.py`: 请求日志、操作记录、JWT刷新等中间件
- `exception.py`: 统一异常处理和错误响应格式
- `dependencies.py`: 认证、权限等依赖注入组件

### 4. 数据访问层 (`db/`)

**功能**: 数据库抽象和基础操作

```
db/
├── __init__.py
└── db_base.py                  # 数据库基础操作封装
```

### 5. 工具层 (`utils/`)

**功能**: 跨模块的公共工具函数

```
utils/
├── __init__.py
├── response.py                # 统一响应格式
├── cache.py                   # 缓存工具
├── tools.py                   # 通用工具函数
├── status.py                  # 状态码定义
├── config/                    # 配置工具
├── excel/                     # Excel处理工具
├── file/                      # 文件处理工具
├── llm/                       # AI/LLM 相关工具
├── parsers/                   # 数据解析工具
├── sms/                       # 短信服务工具
├── wx/                        # 微信相关工具
└── prompts/                   # AI 提示词模板
```

**工具分类**:
- 基础工具：响应格式、缓存、文件处理
- 集成工具：第三方服务集成（短信、微信、AI等）
- 解析工具：数据格式转换和解析
- 配置工具：配置文件读取和管理

### 6. 脚本工具层 (`scripts/`)

**功能**: 自动化脚本和代码生成工具

```
scripts/
├── __init__.py
├── create_app/                # 应用模块生成器
│   ├── main.py
│   └── template/              # 模块模板文件
├── crud_generate/             # CRUD代码生成器
├── initialize/                # 数据初始化脚本
├── generate_requirements.py   # 依赖文件生成
└── reset_sequences.py         # 数据库序列重置
```

**自动化工具**:
- 应用模块生成：自动创建标准的应用模块结构
- CRUD生成：根据模型自动生成CRUD代码
- 数据初始化：初始化基础数据
- 数据库工具：序列重置、迁移管理

### 7. 数据迁移层 (`alembic/`)

**功能**: 数据库版本控制和迁移

```
alembic/
├── env.py                     # Alembic 环境配置
├── script.py.mako             # 迁移脚本模板
├── versions/                  # 生产环境迁移文件
├── versions_dev/              # 开发环境迁移文件
└── versions_pro/              # 生产专用迁移文件
```

**迁移管理**:
- 环境隔离：不同环境使用不同的迁移版本目录
- 版本控制：支持数据库结构版本管理
- 自动生成：基于模型变更自动生成迁移脚本

### 8. 静态资源层 (`static/`)

**功能**: 静态文件存储和管理

```
static/
├── system/                    # 系统静态文件
│   ├── favicon.ico
│   └── logo.png
├── swagger_ui/                # Swagger UI 资源
├── redoc_ui/                  # ReDoc UI 资源
└── {business_files}/          # 业务相关静态文件
```

### 9. 文档层 (`docs/`)

**功能**: 项目文档和开发指南

```
docs/
├── dev/                       # 开发文档
│   ├── 快速开发规范.md
│   ├── 详细开发规范.md
│   └── 功能模块新增指南.md
├── database/                  # 数据库文档
│   ├── ORM 框架查询使用指南.md
│   └── 原生 SQL 查询使用指南.md
└── {feature_docs}/            # 功能特定文档
```

### 10. 主程序入口 (`main.py`)

**功能**: 应用启动和命令行工具

```python
# 主要功能
- create_app(): FastAPI 应用工厂函数
- run(): 启动开发服务器
- init(): 初始化数据库数据
- migrate(): 数据库迁移
- init_app(): 生成新应用模块
- reset_sequences(): 重置数据库序列
```

## 配置管理架构

### 配置层次结构

1. **主配置文件** (`application/settings.py`)
   - 通用配置项
   - 功能开关
   - 中间件配置
   - 安全配置

2. **环境配置文件** (`application/config/`)
   - `development.py`: 开发环境配置
   - `production.py`: 生产环境配置
   - 数据库连接配置
   - 第三方服务配置

3. **应用配置文件** (`config_data/`)
   - JSON格式的应用配置
   - 动态配置项
   - 业务参数配置

### 配置加载机制

```python
# 环境变量驱动配置选择
DEBUG = os.getenv("TF_APP_ENV", True) not in ("production", "prod")

if DEBUG:
    from application.config.development import *
else:
    from application.config.production import *
```

## 数据库架构

### 多数据库支持

1. **主数据库** (PostgreSQL/MySQL)
   - SQLAlchemy ORM
   - 异步连接池
   - 自动事务管理

2. **缓存数据库** (Redis)
   - 会话存储
   - 缓存管理
   - 消息队列

3. **文档数据库** (MongoDB)
   - 日志存储
   - 非结构化数据
   - 分析数据

### 数据库连接管理

```python
# 核心特性
- 异步连接池
- 连接预检查
- 自动重连
- 事务管理
- 多环境配置
```

## 中间件架构

### 中间件堆栈

1. **请求日志中间件**: 记录所有HTTP请求
2. **操作记录中间件**: 记录数据修改操作到MongoDB
3. **JWT刷新中间件**: 自动刷新即将过期的JWT令牌
4. **演示环境中间件**: 限制演示环境的写操作
5. **CORS中间件**: 跨域请求处理

### 中间件配置

```python
# 动态中间件加载
MIDDLEWARES = [
    "core.middleware.register_request_log_middleware" if REQUEST_LOG_RECORD else None,
    "core.middleware.register_operation_record_middleware" if OPERATION_LOG_RECORD and MONGO_DB_ENABLE else None,
    "core.middleware.register_demo_env_middleware" if DEMO else None,
    "core.middleware.register_jwt_refresh_middleware"
]
```

## 认证授权架构

### 认证机制

1. **JWT令牌认证**
   - Access Token (1天)
   - Refresh Token (2天)
   - 自动刷新机制

2. **OAuth2密码流**
   - 标准OAuth2实现
   - 灵活的错误处理
   - 开放认证支持

3. **权限控制**
   - 基于角色的访问控制(RBAC)
   - 细粒度权限管理
   - 接口级权限控制

## 任务处理架构

### 异步任务系统

```
task_processor/
├── celery_app.py              # Celery应用配置
├── tasks.py                   # 任务定义
├── processors/                # 任务处理器
├── embedded_task_manager.py   # 内嵌任务管理器
└── file_processing_tasks.py   # 文件处理任务
```

### 任务特性

- Celery分布式任务队列
- 文件处理任务
- 邮件处理任务
- 定时任务支持
- 任务状态跟踪

## API文档架构

### 文档系统

1. **Swagger UI**: 交互式API文档
2. **ReDoc**: 静态API文档
3. **自定义文档**: 静态资源本地化

### 文档配置

```python
# 自定义API文档
- 本地化资源文件
- 自定义主题
- 统一文档入口
- 版本信息管理
```

## 日志架构

### 日志层次

1. **应用日志** (`logs/`)
   - info 级别日志
   - error 级别日志
   - 按日期分割

2. **请求日志**
   - 中间件自动记录
   - 请求响应详情
   - 性能监控

3. **操作日志**
   - MongoDB存储
   - 数据变更记录
   - 审计追踪

## 开发工具架构

### 代码生成工具

1. **应用模块生成器**
   ```bash
   python main.py init-app {app_name}
   ```

2. **CRUD代码生成器**
   - 基于模型自动生成
   - 标准CRUD操作
   - RESTful API

3. **数据库工具**
   ```bash
   python main.py migrate        # 数据库迁移
   python main.py init          # 数据初始化
   python main.py reset-sequences  # 序列重置
   ```

## 部署架构建议

### 环境隔离

1. **开发环境**
   - 本地数据库
   - 调试模式开启
   - 热重载

2. **生产环境**
   - 外部数据库
   - 性能优化配置
   - 错误监控

### 容器化部署

```dockerfile
# 建议的Docker配置
- 多阶段构建
- 依赖缓存优化
- 健康检查
- 环境变量配置
```

## 最佳实践

### 代码组织

1. **单一职责**: 每个模块专注单一业务领域
2. **依赖注入**: 使用FastAPI的依赖注入系统
3. **异步优先**: 优先使用异步操作
4. **类型提示**: 完整的类型注解

### 数据库设计

1. **模型继承**: 使用基础模型类
2. **异步ORM**: SQLAlchemy异步操作
3. **连接池**: 合理配置连接池参数
4. **迁移管理**: 使用Alembic管理数据库变更

### 安全实践

1. **参数验证**: Pydantic模型验证
2. **SQL注入防护**: ORM参数化查询
3. **JWT安全**: 合理的令牌过期时间
4. **CORS配置**: 适当的跨域策略

### 性能优化

1. **异步编程**: 全面使用async/await
2. **连接池**: 数据库连接池优化
3. **缓存策略**: Redis缓存热点数据
4. **分页查询**: 大数据量分页处理

## 扩展指南

### 添加新应用模块

1. 使用脚本生成基础结构
2. 定义数据模型
3. 创建API接口
4. 注册路由
5. 编写测试

### 集成第三方服务

1. 在 `utils/` 下创建集成工具
2. 配置文件添加相关配置
3. 创建服务封装类
4. 添加依赖注入

### 添加中间件

1. 在 `core/middleware.py` 中定义
2. 在 `settings.py` 中注册
3. 考虑执行顺序
4. 添加配置开关

这个架构模板提供了一个完整、可扩展的FastAPI项目基础，适用于中大型Web应用程序的快速开发和部署。通过遵循这个架构模式，可以确保项目的可维护性、可扩展性和开发效率。
